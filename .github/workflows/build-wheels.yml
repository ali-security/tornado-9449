name: Build Windows Wheels

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # Allow manual triggers

jobs:
  build-windows-wheels:
    name: Build tornado-5.1.1 - Python ${{ matrix.python-version }} (${{ matrix.arch-name }})
    runs-on: windows-2019
    strategy:
      matrix:
        include:
          # Python 3.5 - 32-bit and 64-bit
          - python-version: '3.5'
            arch: 'x86'
            arch-name: 'win32'
          - python-version: '3.5'
            arch: 'x64'
            arch-name: 'win_amd64'
          
          # Python 3.6 - 32-bit and 64-bit
          - python-version: '3.6'
            arch: 'x86'
            arch-name: 'win32'
          - python-version: '3.6'
            arch: 'x64'
            arch-name: 'win_amd64'
          
          # Python 3.7 - 32-bit and 64-bit
          - python-version: '3.7'
            arch: 'x86'
            arch-name: 'win32'
          - python-version: '3.7'
            arch: 'x64'
            arch-name: 'win_amd64'
    
    env:
      TORNADO_EXTENSION: "1"
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }} (${{ matrix.arch }})
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        architecture: ${{ matrix.arch }}
    
    - name: Display Python version and architecture
      run: |
        python --version
        python -c "import struct; print('Architecture:', struct.calcsize('P') * 8, 'bit')"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install wheel
    
    - name: Build wheel
      run: |
        python setup.py bdist_wheel
    
    - name: List built wheels
      run: |
        dir dist\
    
    - name: Verify wheel name
      run: |
        python -c "import os; files = os.listdir('dist'); print('Built:', files[0] if files else 'No files'); pyver = '${{ matrix.python-version }}'.replace('.', ''); expected = 'tornado-5.1.1-cp' + pyver + 'm-cp' + pyver + 'm-${{ matrix.arch-name }}.whl'; print('Expected: ' + expected)"
    
    - name: Upload wheels as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tornado-windows-wheels-py${{ matrix.python-version }}-${{ matrix.arch-name }}
        path: dist/*.whl
        if-no-files-found: error
  
  # Summary job to collect all wheels
  collect-wheels:
    name: Collect All Wheels
    needs: build-windows-wheels
    runs-on: ubuntu-latest
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: tornado-windows-wheels-*
        path: all-wheels
        merge-multiple: true
    
    - name: List all wheels
      run: |
        echo "Built wheels:"
        ls -lh all-wheels/
    
    - name: Re-upload all wheels together
      uses: actions/upload-artifact@v4
      with:
        name: tornado-5.1.1-3-windows-wheels
        path: all-wheels/*.whl
